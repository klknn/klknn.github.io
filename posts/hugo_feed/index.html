<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>はてなブログ的なfeedをHugoで生成</title><style>@media(prefers-color-scheme:dark){body{background-color:#222;color:#ddd}a:link{color:#88c}a:visited{color:#bbc}a:hover{color:#f88}a:active{color:#f80}}h1,h2,h3,h4,h5,h6{margin:2rem auto 1rem;max-width:50rem}.toc{max-width:45rem;padding:1rem;border:dotted}p,.highlight,.gist-file,figure,div,hr{margin:1rem auto;max-width:50rem;width:90%}blockquote{margin:1rem auto;max-width:45rem;font-style:italic;border-left:solid 5px}ul,li{margin:.75rem auto;max-width:50rem}img{width:100%}table,th,td{border-collapse:collapse;border:1px solid;line-height:1.5;padding:10px;border-left:none;border-right:none;margin:1rem auto;max-width:50rem}figcaption{text-align:center;font-style:italic}.index-date{text-align:right;font-style:italic}pre{overflow:scroll}</style><script>MathJax={tex:{tags:"ams",inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js></script></head><body><a href=/>klknn log</a> /
<a href=/posts/>posts</a> /
<a href=/tags/>tags</a> /
<a href=/about/>about</a> /
<a href=/index.xml>feed</a><h1>はてなブログ的なfeedをHugoで生成</h1><ul>date: 2022-08-24 23:32:31 +0900 <a href=https://github.com/klknn/klknn.github.io/edit/develop/content/posts/hugo_feed.md>edit</a></ul><ul>tags: <a href=/tags/hugo/>hugo</a></ul><div class=toc>Table of contents<nav id=TableOfContents><ul><li><a href=#はてなのfeed>はてなのfeed</a></li><li><a href=#hugoのfeed>Hugoのfeed</a></li><li><a href=#まとめ>まとめ</a></li></ul></nav></div><p>RSSリーダーのFeedlyを使っていて、はてなブログとかは全文リーダー内に表示されるのに、うちだけ表示されないな？と疑問に思っていました。
今回ははてなブログのフィードとHugoのデフォルトのフィードを比べた上でよりRSSリーダーフレンドリーなフィードを構築していきます。</p><h2 id=はてなのfeed>はてなのfeed</h2><p>まずFeedlyで適当に普段読んでるhatenaブログをみてみると、取得してるURLが設定画面で把握できます。大抵は以下のようなXMLがでてきます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;feed</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://www.w3.org/2005/Atom&#34;</span> <span style=color:#a6e22e>xml:lang=</span><span style=color:#e6db74>&#34;ja&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;title&gt;</span>・ｘ・ぼくののうみそ<span style=color:#f92672>&lt;/title&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;link</span> <span style=color:#a6e22e>href=</span><span style=color:#e6db74>&#34;https://bokunonoumiso.hatenablog.com/&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;updated&gt;</span>2022-08-09T12:41:41+09:00<span style=color:#f92672>&lt;/updated&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;author&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;name&gt;</span>bokunonoumiso<span style=color:#f92672>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/author&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;generator</span> <span style=color:#a6e22e>uri=</span><span style=color:#e6db74>&#34;https://blog.hatena.ne.jp/&#34;</span> <span style=color:#a6e22e>version=</span><span style=color:#e6db74>&#34;149d375eb29bfc5c8439e961a2b85a&#34;</span><span style=color:#f92672>&gt;</span>Hatena::Blog<span style=color:#f92672>&lt;/generator&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;id&gt;</span>hatenablog://blog/6653812171403772804<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;entry&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;title&gt;</span>高い車に乗って安い車を煽る<span style=color:#f92672>&lt;/title&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;link</span> <span style=color:#a6e22e>href=</span><span style=color:#e6db74>&#34;https://bokunonoumiso.hatenablog.com/entry/2022/08/09/124141&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;id&gt;</span>hatenablog://entry/4207112889907092076<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;published&gt;</span>2022-08-09T12:41:41+09:00<span style=color:#f92672>&lt;/published&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;updated&gt;</span>2022-08-09T12:41:41+09:00<span style=color:#f92672>&lt;/updated&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;summary</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;html&#34;</span><span style=color:#f92672>&gt;</span>高い車が安い車を煽る…<span style=color:#f92672>&lt;/summary&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;content</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;html&#34;</span><span style=color:#f92672>&gt;</span>&amp;lt;p&amp;gt;高い車が安い車を煽る&amp;lt;/p&amp;gt;<span style=color:#f92672>&lt;/content&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;/entry&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/feed&gt;</span>
</span></span></code></pre></div><p>注意点としては</p><ul><li>RSS 1.0/2.0ではなく<a href=http://www.w3.org/2005/Atom>ATOM規格</a>っぽい。summaryに概要、contentに本文を入れることができる。</li><li>summaryでは多くのリーダーで対応するために、htmlタグなしの plainify されたテキストが良さそう。</li><li>contentの中身はhtmlなので、escape するか CDATA 属性に突っ込む。なおhugo組み込み関数のescapeHTMLでは<code>&</code>も変換されてしまいうまくいかなかった。</li><li>もし RSS 1.0/2.0 を使いたい場合、本文を表示するには <code>&lt;content:encoded></code> を使うと良いらしい <a href=https://www.w3.org/wiki/RssContent>https://www.w3.org/wiki/RssContent</a></li></ul><h2 id=hugoのfeed>Hugoのfeed</h2><p><a href=https://github.com/gohugoio/hugo/blob/988e1417a057b937a766385f79f46a52e933baee/tpl/tplimpl/embedded/templates/_default/rss.xml>Hugo標準付属のrss.xml</a>はRSS 2.0なのかAtomなのかよくわからない感じですね。
hatenaブログのフィードっぽくしたテンプレートはこんな感じです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>{{- $pctx := . -}}
</span></span><span style=display:flex><span>{{- if .IsHome -}}{{ $pctx = .Site }}{{- end -}}
</span></span><span style=display:flex><span>{{- $pages := slice -}}
</span></span><span style=display:flex><span>{{- if or $.IsHome $.IsSection -}}
</span></span><span style=display:flex><span>{{- $pages = $pctx.RegularPages -}}
</span></span><span style=display:flex><span>{{- else -}}
</span></span><span style=display:flex><span>{{- $pages = $pctx.Pages -}}
</span></span><span style=display:flex><span>{{- end -}}
</span></span><span style=display:flex><span>{{- $limit := .Site.Config.Services.RSS.Limit -}}
</span></span><span style=display:flex><span>{{- if ge $limit 1 -}}
</span></span><span style=display:flex><span>{{- $pages = $pages | first $limit -}}
</span></span><span style=display:flex><span>{{- end -}}
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;feed</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://www.w3.org/2005/Atom&#34;</span> <span style=color:#a6e22e>xml:lang=</span><span style=color:#e6db74>&#34;ja&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;title&gt;</span>{{ if eq  .Title  .Site.Title }}{{ .Site.Title }}{{ else }}{{ with .Title }}{{.}} on {{ end }}{{ .Site.Title }}{{ end }}<span style=color:#f92672>&lt;/title&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;link</span> <span style=color:#a6e22e>href=</span><span style=color:#e6db74>&#34;{{ .Permalink }}&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;updated&gt;</span>{{ time.Format &#34;2006-01-02T15:04:05-0700&#34; .Site.LastChange | safeHTML }}<span style=color:#f92672>&lt;/updated&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;author&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;name&gt;</span>{{ $.Site.Params.author }}<span style=color:#f92672>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/author&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;generator</span> <span style=color:#a6e22e>uri=</span><span style=color:#e6db74>&#34;https://gohugo.io&#34;</span> <span style=color:#a6e22e>version=</span><span style=color:#e6db74>&#34;{{ hugo.Version }}&#34;</span><span style=color:#f92672>&gt;</span>Hugo<span style=color:#f92672>&lt;/generator&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;id&gt;</span>{{ .Permalink }}<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  {{ range $pages }}
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;entry&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;title&gt;</span>{{ .Title }}<span style=color:#f92672>&lt;/title&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;link</span> <span style=color:#a6e22e>href=</span><span style=color:#e6db74>&#34;{{ .Permalink }}&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;id&gt;</span>{{ .Permalink }}<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;published&gt;</span>{{ .PublishDate.Format &#34;2006-01-02T15:04:05-0700&#34; | safeHTML }}<span style=color:#f92672>&lt;/published&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;updated&gt;</span>{{ .Lastmod.Format &#34;2006-01-02T15:04:05-0700&#34; | safeHTML }}<span style=color:#f92672>&lt;/updated&gt;</span>
</span></span><span style=display:flex><span>    {{ with .Site.Author.email }}<span style=color:#f92672>&lt;author&gt;</span>{{.}}{{ with $.Site.Author.name }} ({{.}}){{end}}<span style=color:#f92672>&lt;/author&gt;</span>{{end}}
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;summary</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;html&#34;</span><span style=color:#f92672>&gt;</span>{{ .Summary | plainify }}...<span style=color:#f92672>&lt;/summary&gt;</span>
</span></span><span style=display:flex><span>    {{ printf `<span style=color:#f92672>&lt;content</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;html&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#75715e>&lt;![CDATA[%s]]&gt;</span><span style=color:#f92672>&lt;/content&gt;</span>` .Content | safeHTML }}
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/entry&gt;</span>
</span></span><span style=display:flex><span>  {{ end }}
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/feed&gt;</span>
</span></span></code></pre></div><p>詳細は以下のcommitを見てください。</p><p><a href=https://github.com/klknn/klknn.github.io/commit/afb831f515d54b451e70fbc5e5ae95e669d79c75>https://github.com/klknn/klknn.github.io/commit/afb831f515d54b451e70fbc5e5ae95e669d79c75</a></p><h2 id=まとめ>まとめ</h2><p>RSSリーダーって10年前まではみんな使ってたのにGoogle readerが終わって一気に死んだよね&mldr;インターネット老人ネタでした。</p>Copyright © klknn All Rights Reserved.</body></html>